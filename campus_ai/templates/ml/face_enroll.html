<!DOCTYPE html>
<html>
<head>
    <title>Face Enrollment</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
</head>

<body class="container mt-4">

<h3 class="mb-3">Face Enrollment</h3>

<!-- Student Info -->
<div class="alert alert-info">
    <strong>Student ID:</strong> {{ student.user_id }}
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Webcam Preview -->
    <div class="mb-3">
        <video id="video" width="320" height="240" autoplay
               class="border"></video>
        <canvas id="canvas" width="320" height="240"
                style="display:none;"></canvas>
    </div>

    <!-- Camera Controls -->
    <div class="mb-3">
        <button type="button" class="btn btn-secondary"
                onclick="startCamera()">
            Start Camera
        </button>

        <button type="button" class="btn btn-warning"
                onclick="capturePhoto()">
            Capture Photo
        </button>
    </div>

    <!-- Hidden field for webcam image -->
    <input type="hidden" name="captured_image" id="captured_image">

    <hr>

    <!-- Upload fallback -->
    <div class="mb-3">
        <label class="form-label">
            Or upload a face image
        </label>
        <input type="file"
               name="uploaded_image"
               accept="image/*"
               capture="environment"
               class="form-control">
    </div>

    <button type="submit" class="btn btn-success">
        Save Face
    </button>
</form>

<!-- Webcam JS -->
<script>
let videoStream = null;

function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            videoStream = stream;
            document.getElementById('video').srcObject = stream;
        })
        .catch(() => {
            alert("Unable to access camera");
        });
}

function capturePhoto() {
    const canvas = document.getElementById('canvas');
    const video = document.getElementById('video');

    canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
    document.getElementById('captured_image').value =
        canvas.toDataURL('image/png');

    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }

    alert("Photo captured successfully");
}
</script>

</body>
</html>
